{% extends "base.html" %}

{% block title %}Data Generator{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Configure Data Schema</h5>
                </div>
                <div class="card-body">
                    <!-- Output Settings -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Output Settings</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Rows</label>
                                <input type="number" class="form-control" id="rowCount" value="100" min="1" max="{{ current_user.get_max_rows() }}">
                                <small class="text-muted">Max: {{ "{:,}".format(current_user.get_max_rows()) }}</small>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Format</label>
                                <select class="form-select" id="outputFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="sql">SQL</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2" id="tableNameGroup" style="display: none;">
                            <label class="form-label small">Table Name (for SQL)</label>
                            <input type="text" class="form-control" id="tableName" value="synthetic_data">
                        </div>
                    </div>

                    <!-- Fields Section -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Fields</label>
                            <button class="btn btn-sm btn-outline-primary" onclick="addField()">
                                <i class="bi bi-plus-lg me-1"></i>Add Field
                            </button>
                        </div>
                        <div id="fieldsContainer">
                            <!-- Fields will be added here -->
                        </div>
                        <div class="text-center text-muted py-4" id="noFieldsMessage">
                            <i class="bi bi-database fs-3"></i>
                            <p class="mt-2 mb-0">Click "Add Field" to define your data schema</p>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button class="btn btn-primary w-100 py-2" onclick="generateData()" id="generateBtn">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Generate Data
                    </button>

                    <!-- Usage Info -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            {{ current_user.requests_today }} / {{ current_user.get_daily_limit() }} requests used today
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Output Preview</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="copyOutput()" id="copyBtn" disabled>
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadOutput()" id="downloadBtn" disabled>
                            <i class="bi bi-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="bg-dark text-light p-4" style="min-height: 500px; max-height: 600px; overflow: auto;">
                        <pre class="mb-0" id="outputPreview"><code class="text-muted">// Generated data will appear here...</code></pre>
                    </div>
                </div>
                <div class="card-footer text-muted small" id="outputStats">
                    Ready to generate
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field Template (hidden) -->
<template id="fieldTemplate">
    <div class="card mb-2 field-card" data-field-index="">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-secondary field-number">Field 1</span>
                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeField(this)">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <input type="text" class="form-control form-control-sm field-name" placeholder="Field name">
                </div>
                <div class="col-6">
                    <select class="form-select form-select-sm field-type" onchange="updateConstraints(this)">
                        <option value="">Select type...</option>
                        {% for type in field_types %}
                        <option value="{{ type.value }}">{{ type.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="constraints-container mt-2" style="display: none;">
                <!-- Constraints will be added dynamically -->
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
let fieldCount = 0;
let generatedData = null;
let currentFormat = 'json';

// Field type constraints configuration
const fieldConstraints = {
    integer: [
        { name: 'min', label: 'Min', type: 'number', default: 1 },
        { name: 'max', label: 'Max', type: 'number', default: 1000 }
    ],
    float: [
        { name: 'min', label: 'Min', type: 'number', default: 0 },
        { name: 'max', label: 'Max', type: 'number', default: 100 },
        { name: 'precision', label: 'Decimals', type: 'number', default: 2 }
    ],
    string: [
        { name: 'min_length', label: 'Min Length', type: 'number', default: 5 },
        { name: 'max_length', label: 'Max Length', type: 'number', default: 20 }
    ],
    date: [
        { name: 'start', label: 'Start Date', type: 'date', default: '2024-01-01' },
        { name: 'end', label: 'End Date', type: 'date', default: '2024-12-31' }
    ],
    datetime: [
        { name: 'start', label: 'Start Date', type: 'date', default: '2024-01-01' },
        { name: 'end', label: 'End Date', type: 'date', default: '2024-12-31' }
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    // Show/hide table name field based on format
    document.getElementById('outputFormat').addEventListener('change', function() {
        document.getElementById('tableNameGroup').style.display =
            this.value === 'sql' ? 'block' : 'none';
        currentFormat = this.value;
    });

    // Add initial field
    addField();
});

function addField() {
    const container = document.getElementById('fieldsContainer');
    const template = document.getElementById('fieldTemplate');
    const clone = template.content.cloneNode(true);

    fieldCount++;
    const card = clone.querySelector('.field-card');
    card.dataset.fieldIndex = fieldCount;
    card.querySelector('.field-number').textContent = 'Field ' + fieldCount;

    container.appendChild(clone);
    document.getElementById('noFieldsMessage').style.display = 'none';
    updateFieldNumbers();
}

function removeField(btn) {
    const card = btn.closest('.field-card');
    card.remove();

    const container = document.getElementById('fieldsContainer');
    if (container.children.length === 0) {
        document.getElementById('noFieldsMessage').style.display = 'block';
    }
    updateFieldNumbers();
}

function updateFieldNumbers() {
    const cards = document.querySelectorAll('.field-card');
    cards.forEach((card, index) => {
        card.querySelector('.field-number').textContent = 'Field ' + (index + 1);
    });
}

function updateConstraints(select) {
    const card = select.closest('.field-card');
    const constraintsContainer = card.querySelector('.constraints-container');
    const fieldType = select.value;

    constraintsContainer.innerHTML = '';

    if (fieldConstraints[fieldType]) {
        constraintsContainer.style.display = 'block';
        const row = document.createElement('div');
        row.className = 'row g-2';

        fieldConstraints[fieldType].forEach(constraint => {
            const col = document.createElement('div');
            col.className = 'col-6';
            col.innerHTML = `
                <label class="form-label small mb-1">${constraint.label}</label>
                <input type="${constraint.type}" class="form-control form-control-sm constraint-input"
                       data-constraint="${constraint.name}" value="${constraint.default}">
            `;
            row.appendChild(col);
        });

        constraintsContainer.appendChild(row);
    } else {
        constraintsContainer.style.display = 'none';
    }
}

function getFieldsConfig() {
    const fields = [];
    const cards = document.querySelectorAll('.field-card');

    cards.forEach(card => {
        const name = card.querySelector('.field-name').value.trim();
        const type = card.querySelector('.field-type').value;

        if (name && type) {
            const field = { name, type, constraints: {} };

            card.querySelectorAll('.constraint-input').forEach(input => {
                const value = input.type === 'number' ? parseFloat(input.value) : input.value;
                field.constraints[input.dataset.constraint] = value;
            });

            fields.push(field);
        }
    });

    return fields;
}

async function generateData() {
    const fields = getFieldsConfig();

    if (fields.length === 0) {
        alert('Please add at least one field with a name and type.');
        return;
    }

    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

    try {
        const response = await fetch('/generator/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                rows: parseInt(document.getElementById('rowCount').value),
                format: document.getElementById('outputFormat').value,
                table_name: document.getElementById('tableName').value,
                fields: fields
            })
        });

        const result = await response.json();

        if (result.error) {
            alert(result.error);
            return;
        }

        generatedData = result.data;
        currentFormat = result.format;

        // Display output
        const preview = document.getElementById('outputPreview');
        preview.innerHTML = `<code>${escapeHtml(generatedData)}</code>`;

        // Update stats
        document.getElementById('outputStats').textContent =
            `Generated ${result.rows} rows in ${result.format.toUpperCase()} format`;

        // Enable buttons
        document.getElementById('copyBtn').disabled = false;
        document.getElementById('downloadBtn').disabled = false;

    } catch (error) {
        alert('Error generating data: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightning-charge-fill me-2"></i>Generate Data';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyOutput() {
    if (generatedData) {
        navigator.clipboard.writeText(generatedData);
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        setTimeout(() => {
            btn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
        }, 2000);
    }
}

async function downloadOutput() {
    if (generatedData) {
        const response = await fetch('/generator/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                content: generatedData,
                format: currentFormat,
                filename: 'synthetic_data'
            })
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `synthetic_data.${currentFormat === 'json' ? 'json' : currentFormat === 'csv' ? 'csv' : 'sql'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    }
}
</script>
{% endblock %}
