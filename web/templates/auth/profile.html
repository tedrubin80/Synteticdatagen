{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center p-4">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex p-4 mb-3">
                        <i class="bi bi-person-fill text-primary fs-1"></i>
                    </div>
                    <h4>{{ current_user.username }}</h4>
                    <p class="text-muted">{{ current_user.email }}</p>
                    <span class="badge {% if current_user.is_pro %}bg-warning{% else %}bg-secondary{% endif %}">
                        {% if current_user.is_pro %}Pro{% else %}Free{% endif %} Plan
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <!-- Usage Stats -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Usage Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary">{{ current_user.requests_today }}</h3>
                                <p class="text-muted mb-0">Requests Today</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">{{ current_user.total_requests }}</h3>
                                <p class="text-muted mb-0">Total Requests</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info">{{ current_user.get_daily_limit() }}</h3>
                                <p class="text-muted mb-0">Daily Limit</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label small text-muted">Daily Usage</label>
                        <div class="progress" style="height: 10px;">
                            {% set usage_percent = (current_user.requests_today / current_user.get_daily_limit() * 100) | int %}
                            <div class="progress-bar {% if usage_percent > 80 %}bg-danger{% elif usage_percent > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                 role="progressbar"
                                 style="width: {{ usage_percent }}%">
                            </div>
                        </div>
                        <small class="text-muted">{{ current_user.requests_today }} / {{ current_user.get_daily_limit() }} requests used</small>
                    </div>
                </div>
            </div>

            <!-- API Key -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-key me-2"></i>API Key</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Use this key to authenticate API requests. Keep it secret!</p>
                    <div class="input-group mb-3">
                        <input type="password" class="form-control font-monospace" id="apiKey"
                               value="{{ current_user.api_key }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                            <i class="bi bi-eye" id="toggleIcon"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyApiKey()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <form method="POST" action="{{ url_for('auth.regenerate_api_key') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Are you sure? This will invalidate your current API key.')">
                            <i class="bi bi-arrow-repeat me-1"></i>Regenerate Key
                        </button>
                    </form>
                </div>
            </div>

            <!-- Account Info -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Account Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Member Since</td>
                            <td>{{ current_user.created_at.strftime('%B %d, %Y') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Account Status</td>
                            <td><span class="badge bg-success">Active</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Max Rows per Request</td>
                            <td>{{ "{:,}".format(current_user.get_max_rows()) }}</td>
                        </tr>
                    </table>

                    {% if not current_user.is_pro %}
                    <hr>
                    <div class="bg-primary bg-opacity-10 rounded p-3">
                        <h6><i class="bi bi-star-fill text-warning me-2"></i>Upgrade to Pro</h6>
                        <p class="small mb-2">Get 10,000 requests/day and generate up to 100,000 rows per request.</p>
                        <a href="{{ url_for('main.pricing') }}" class="btn btn-primary btn-sm">View Plans</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleApiKey() {
    const input = document.getElementById('apiKey');
    const icon = document.getElementById('toggleIcon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
}

function copyApiKey() {
    const input = document.getElementById('apiKey');
    navigator.clipboard.writeText(input.value);
    alert('API key copied to clipboard!');
}
</script>
{% endblock %}
